import { useEffect, useState } from 'react';
import { Session } from '../App';
import config from '../config';
import axios from 'axios';
import './teacher.css';

export type TeacherParams = {
    user: Session,
    logout: () => void
}

export type Tests = {
    [key: string]: {
        [key: string]: {
            statement: string,
            answer: string,
        }
    }
}

const Course = ({ name, jwt, logout }: { name: string, jwt: string, logout: () => void }) => {
    const [tests, setTests] = useState<Tests>({});
    useEffect(() => {
        axios.get(
            `${config.baseUrl}/cadeira/${name}/test-answers`,
            { headers: { Authorization: `Bearer ${jwt}` } }
        )
            .then(t => setTests(t.data))
            .catch(_ => logout());
    }, [name, jwt, logout])
    return (
        <div>
            {Object.keys(tests).length > 0 ? <></> : <p className="warning">Não há testes</p>}
            {Object.keys(tests).flatMap((t, ti) => (
                <div key={ti}>
                    <h3>{t}° teste</h3>
                    {
                        Object.keys(tests[t]).map((question, qi) => (
                            <div key={`${ti}-${qi}`}>
                                <p>Q: {tests[t][question].statement}</p>
                                <p>A: {tests[t][question].answer}</p>
                            </div>
                        ))
                    }
                </div>
            )
            )}
        </div>
    )
}

export const Teacher = ({ user, logout }: TeacherParams) => {
    const [cadeiras, setCadeiras] = useState<string[]>([]);
    const [selected, setSelected] = useState<string | undefined>(undefined);

    useEffect(() => {
        axios.get(
            `${config.baseUrl}/cadeira/all`,
            { headers: { Authorization: `Bearer ${user.jwt}` } }
        )
            .then(res => setCadeiras(res.data))
            .catch(_ => logout());
    }, [user.jwt, logout])

    return (
        <div>
            <div className="globalPanel">
                <div className="topTabs bgBanner"></div>
            </div>
            <div className="contentBox">
                <div className="container">
                    <div className="row-column">
                        <div className="column-one">
                            <div className="section">
                                <div className="title"><span>Unidades Curriculares</span></div>
                                <div className='content'>
                                    {cadeiras.length !== 0 ?
                                        <ul className="list-results">
                                            {cadeiras.map((name, i) => {
                                                return (
                                                    <li
                                                        className="result"
                                                        key={i}
                                                        onClick={() => setSelected(name)}>{name}
                                                    </li>
                                                );
                                            })}
                                        </ul>
                                        : <p className="warning">Selecionar unidade curricular</p>}
                                </div>
                            </div>
                        </div>
                        <div className="column-three">
                            <div className="section">
                                <div className="title"><span>Testes</span></div>
                                <div className='content'>
                                    {selected !== undefined
                                        ? <Course name={selected} jwt={user.jwt} logout={logout} />
                                        : <p className="warning">Selecionar unidade curricular</p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    )
}


