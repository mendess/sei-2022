import { PromisedDatabase } from "promised-sqlite3";
import * as fs from 'fs/promises';

async function migrate(db: PromisedDatabase) {
    const path =__dirname + '/../migrations'
    const files = await fs.readdir(path);
    files.sort();
    for (const f of files) {
        console.log('running migration', f);
        const s = await fs.readFile(`${path}/${f}`)
        try {
            await db.run(s.toString('utf8'));
        } catch (e: any) {
            if (e.errno === 8) console.log(`Error: ${e.code}`);
            else throw e;
        }
    }
}

const db = new PromisedDatabase();
(async () => {
    await db.open('db.sqlite');
    await migrate(db);
})().catch(e => {
    console.log(e);
    process.exit(1);
});

export default db;
